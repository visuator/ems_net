<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <meta
            content="SwaggerUI"
            name="description"
    />
    <title>%(DocumentTitle)</title>
    <link href="https://unpkg.com/swagger-ui-dist@4.5.0/swagger-ui.css" rel="stylesheet"/>
    <link href=" https://cdn.jsdelivr.net/npm/swagger-ui-themes@3.0.1/themes/3.x/theme-material.min.css "
          rel="stylesheet">
    <style>

        html {
            box-sizing: border-box;
            overflow-y: scroll;
        }

        *,
        *:before,
        *:after {
            box-sizing: inherit;
        }

        body {
            margin: 0;
            background: #fafafa;
        }
    </style>
    %(HeadContent)
</head>
<body>
<div id="swagger-ui"></div>
<script>
    if (window.navigator.userAgent.indexOf("Edge") > -1) {
        window.fetch = undefined;
    }
</script>
<script crossorigin src="https://unpkg.com/react@16.7.0/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@16.7.0/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
<script crossorigin src="https://unpkg.com/swagger-ui-dist@4.5.0/swagger-ui-bundle.js"></script>
<script crossorigin src="https://unpkg.com/swagger-ui-dist@4.5.0/swagger-ui-standalone-preset.js"></script>
<script>
    window.onload = function () {
        var configObject = JSON.parse('%(ConfigObject)');
        var oauthConfigObject = JSON.parse('%(OAuthConfigObject)');

        // Workaround for https://github.com/swagger-api/swagger-ui/issues/5945
        configObject.urls.forEach(function (item) {
            if (item.url.startsWith("http") || item.url.startsWith("/")) return;
            item.url = window.location.href.replace("index.html", item.url).split('#')[0];
        });

        // If validatorUrl is not explicitly provided, disable the feature by setting to null
        if (!configObject.hasOwnProperty("validatorUrl"))
            configObject.validatorUrl = null

        // If oauth2RedirectUrl isn't specified, use the built-in default
        if (!configObject.hasOwnProperty("oauth2RedirectUrl"))
            configObject.oauth2RedirectUrl = (new URL("oauth2-redirect.html", window.location.href)).href;

        // Apply mandatory parameters
        configObject.dom_id = "#swagger-ui";

        configObject.requestInterceptor = (request) => {
            return accessTokenInjector(request);
        };
        configObject.responseInterceptor = (response) => {
            return loginEndpointCatcher(response);
        };

        configObject.presets = [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset];
        configObject.layout = "StandaloneLayout";
        configObject.plugins = [
            HideCurlPlugin,
            AuthState,
        ];

        // Begin Swagger UI call region

        const ui = SwaggerUIBundle(configObject);

        ui.initOAuth(oauthConfigObject);

        // End Swagger UI call region

        window.ui = ui
    }
</script>
<script type="text/jsx">
    const HideCurlPlugin = (system) => {
        return {
            wrapComponents: {
                curl: () => () => null
            }
        }
    }
    const AuthState = (system) => {
        return {
            statePlugins: {
                authInterceptors: {
                    selectors: {
                        currentToken: (state) => system.authSelectors.authorized().getIn(['Bearer', 'value']),
                        responseElapsedTime: (state, url) => state.get("responses").find(r => r.url === url).elapsedTime,
                    },
                    actions: {
                        setResponseElapsedTime: (time) => {
                            return {type: "SET_RESPONSE_ELAPSED_TIME", payload: time};
                        }
                    },
                    reducers: {
                        "SET_RESPONSE_ELAPSED_TIME": (state, action) => {
                            const responses = state.get("responses") || [];
                            console.log(responses);
                            const index = responses.findIndex(i => i.url === action.payload.url);
                            if (index > -1) {
                                responses[index] = action.payload;
                            } else {
                                responses.push(action.payload);
                            }
                            return state.set("responses", responses);
                        }
                    }
                }
            },
            wrapComponents: {
                apiKeyAuth: (Original, system) => (props) => {
                    return <Original {...props} onChange={e => {
                        const eventWrap = e.name === "Bearer" ? {
                            name: e.name,
                            schema: e.schema,
                            value: e.value ? `Bearer ${e.value}` : ''
                        } : e;
                        props.onChange(eventWrap);
                    }}/>
                },
                liveResponse: (Original, system) => (props) => {
                    return <div>
                        <h3>Elapsed
                            milliseconds: {system.authInterceptorsSelectors.responseElapsedTime(props.response.get("url")) || '&mdash;'}</h3>
                        <Original {...props}/>
                    </div>
                },
            },
            afterLoad() {
                this.rootInjects = this.rootInjects || {}
                this.rootInjects.currentToken = system.authInterceptorsSelectors.currentToken;
            }
        }
    }
</script>
<script>
    const loginEndpointCatcher = (response) => {
        if (!window.authStorage) {
            window.authStorage = {instance: {accessToken: null, refreshToken: null, expiresAt: null}}
        }
        if (response.url.endsWith('api/v1/auth/login') && response.ok) {
            const left = response.body;
            const right = authStorage.instance;
            authStorage.instance = Object.assign(right, left);
        }
        if (window.ui) {
            window.ui.authInterceptorsActions.setResponseElapsedTime({
                url: response.url,
                elapsedTime: response.headers['x-response-time']
            });
        }

        return response;
    };
    const accessTokenInjector = async (request) => {
        if (window.ui && window.ui.currentToken()) return;
        if (window.authStorage && window.authStorage.instance) {
            if (Date.now() >= new Date(window.authStorage.instance.expiresAt).getTime() && window.authStorage.instance.refreshToken) {
                await fetch(`${window.location.origin}/api/v1/auth/refresh`, {
                    method: 'POST',
                    headers: {'Accept': 'application/json', 'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        refreshToken: authStorage.instance.refreshToken,
                        requestedAt: new Date(Date.now()).toJSON()
                    })
                }).then(async (r) => {
                    window.authStorage.instance = await r.json() ?? {
                        instance: {
                            accessToken: null,
                            refreshToken: null,
                            expiresAt: null
                        }
                    };
                });
            }
            request.headers.Authorization = `Bearer ${window.authStorage.instance.accessToken}`
        }
        return request;
    }
</script>
</body>
</html>